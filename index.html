<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MonLearn ‚Äî –º–æ–Ω–≥–æ–ª—å—Å–∫–∏–π A1 (MVP)</title>
  <style>
/* Minimal, clean, modern UI */
:root{
  --bg: #0b0d10;
  --panel: #141820;
  --panel-2: #0f131a;
  --text: #e8eef6;
  --muted: #a8b3c2;
  --brand: #7dd3fc;
  --brand-2: #60a5fa;
  --ok: #34d399;
  --warn: #f59e0b;
  --danger: #f87171;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
  --radius: 14px;
}

* { box-sizing: border-box; }
html, body { height: 100%; }
body{
  margin: 0;
  background: radial-gradient(1200px 600px at 15% -10%, #10141b 10%, transparent 60%), var(--bg);
  color: var(--text);
  font: 16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
}

.app-header{
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0));
  position: sticky; top: 0; z-index: 10;
  backdrop-filter: blur(8px);
  border-bottom: 1px solid rgba(255,255,255,0.06);
}

.logo{ display: flex; gap: 10px; align-items: center; font-weight: 700; letter-spacing: .5px; }
.streak{ color: var(--warn); font-weight: 700; }

.container{
  display: grid;
  grid-template-columns: 280px 1fr;
  gap: 20px;
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
}

.sidebar{
  background: linear-gradient(180deg, var(--panel), var(--panel-2));
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow);
  position: sticky;
  top: 76px;
  height: fit-content;
}

.sidebar h2{ margin: 8px 0 12px; font-size: 18px; }
.unit-list{
  list-style: none;
  padding: 0;
  margin: 0 0 12px;
  display: grid;
  gap: 8px;
}
.unit-list li{
  display: grid;
  gap: 6px;
  padding: 12px;
  border-radius: 12px;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.05);
}
.unit-list button{
  width: 100%;
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px 12px;
  border-radius: 10px; border: 1px solid rgba(255,255,255,0.06);
  background: #0e1219; color: var(--text);
  cursor: pointer;
}
.unit-list button:hover{ background: #0f141d; }

.content{
  background: linear-gradient(180deg, var(--panel), var(--panel-2));
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: var(--radius);
  padding: 24px;
  min-height: 520px;
  box-shadow: var(--shadow);
}

.screen{ display: none; }
.screen.active{ display: block; }

.lead{ color: var(--muted); max-width: 70ch; }
.cta-row{ display: flex; gap: 12px; flex-wrap: wrap; margin: 12px 0 4px; }

.btn{
  padding: 10px 14px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.1);
  background: #0e1219;
  color: var(--text);
  cursor: pointer;
}
.btn:hover{ background: #0f141d; }
.btn.primary{ background: linear-gradient(90deg, var(--brand), var(--brand-2)); color: #081018; font-weight: 700; border: none; }
.btn.subtle{ background: rgba(255,255,255,0.06); }

.link{
  background: transparent;
  border: none;
  padding: 0;
  color: var(--brand);
  cursor: pointer;
}
.link.danger{ color: var(--danger); }

.tip{ background: rgba(125,211,252,0.06); padding: 12px 16px; border-radius: 12px; border: 1px solid rgba(125,211,252,0.2); }

.lesson-header{ display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
.lesson-title{ font-weight: 700; }
.hearts{ display: inline-flex; gap: 6px; }
.heart{ width: 22px; height: 22px; border-radius: 50%; background: rgba(248,113,113,0.2); border: 1px solid rgba(248,113,113,0.4); position: relative; }
.heart::after{
  content: "‚ô•"; position: absolute; inset: 0; display: grid; place-items: center;
  color: var(--danger); font-size: 14px; font-weight: 700;
}

.card-area{
  display: grid; gap: 14px;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 14px; padding: 16px;
}

.card{
  background: #0f141c;
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 12px;
  padding: 16px;
}
.card h3{ margin: 0 0 8px; }
.card .prompt{ color: var(--muted); margin-bottom: 10px; }

.choices{ display: grid; gap: 8px; }
.choice-btn{
  padding: 10px 12px;
  border-radius: 10px;
  background: #0b1017;
  border: 1px solid rgba(255,255,255,0.08);
  cursor: pointer;
  text-align: left;
}
.choice-btn:hover{ background: #0c1119; }

.tokens{ display: flex; flex-wrap: wrap; gap: 8px; min-height: 44px; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 10px; }
.token{
  padding: 8px 10px; border-radius: 10px; background: #0d1219; border:1px solid rgba(255,255,255,0.08); cursor: pointer;
}
.token[disabled]{ opacity:.5; cursor: default; }

.result{
  padding: 10px 12px; border-radius: 10px;
  background: rgba(52,211,153,0.12); border: 1px solid rgba(52,211,153,0.4);
}
.result.bad{ background: rgba(248,113,113,0.12); border-color: rgba(248,113,113,0.4); }

.footer{
  padding: 20px; text-align: center; color: var(--muted);
}

@media (max-width: 880px){
  .container{ grid-template-columns: 1fr; }
  .sidebar{ position: static; }
}
</style>
</head>
<body>
  <header class="app-header">
    <div class="logo">
      <svg width="28" height="28" viewBox="0 0 24 24" aria-hidden="true">
        <circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.1"/>
        <path d="M6 9h12M8 12h8M10 15h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <span>MonLearn</span>
    </div>
    <div class="streak" id="streak">üî• 0</div>
  </header>

  <main class="container">
    <aside class="sidebar">
      <h2>–ö—É—Ä—Å A1</h2>
      <ol id="unitList" class="unit-list"></ol>
      <div class="small text-muted">–ü—Ä–æ–≥—Ä–µ—Å—Å: <span id="progressPct">0%</span></div>
      <button id="resetProgress" class="link danger">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
    </aside>
    <section class="content">
      <div id="screenHome" class="screen active">
        <h1>–°–∞–π–Ω —É—É! –ù–∞—á–Ω—ë–º?</h1>
        <p class="lead">–ú–∏–Ω–∏-–ø—Ä–æ—Ç–æ—Ç–∏–ø –∫—É—Ä—Å–∞ –º–æ–Ω–≥–æ–ª—å—Å–∫–æ–≥–æ (—Ö–∞–ª—Ö–∞, –∫–∏—Ä–∏–ª–ª–∏—Ü–∞). –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ, –æ—Ñ–ª–∞–π–Ω, —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤ —Å—Ç–∏–ª–µ ¬´—Å–æ–±–µ—Ä–∏ —Ñ—Ä–∞–∑—É¬ª –∏ ¬´–≤—ã–±–µ—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥¬ª.</p>
        <div class="cta-row">
          <button id="startLesson" class="btn primary">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É—Ä–æ–∫</button>
          <button id="reviewBtn" class="btn">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ (SRS)</button>
        </div>
        <details class="tip">
          <summary>–°–æ–≤–µ—Ç</summary>
          <p>–ö–ª–∏–∫–Ω–∏—Ç–µ —Å–ª–µ–≤–∞ –Ω–∞ –º–æ–¥—É–ª—å –∏–ª–∏ –∂–º–∏—Ç–µ ¬´–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É—Ä–æ–∫¬ª. –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.</p>
        </details>
      </div>

      <div id="screenLesson" class="screen">
        <div class="lesson-header">
          <div id="lessonTitle" class="lesson-title"></div>
          <div class="hearts" id="hearts" aria-label="–ñ–∏–∑–Ω–∏"></div>
        </div>
        <div id="cardArea" class="card-area"></div>
        <div class="lesson-actions">
          <button id="skipCard" class="btn subtle">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
        </div>
      </div>

      <div id="screenComplete" class="screen">
        <h2>–£—Ä–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω üéâ</h2>
        <p>–û—Ç–ª–∏—á–Ω–æ! –ü–æ–ª—É—á–µ–Ω–æ <strong><span id="xpGained">0</span> XP</strong>.</p>
        <div class="cta-row">
          <button id="backHome" class="btn">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
          <button id="toReview" class="btn primary">–ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é</button>
        </div>
      </div>

      <div id="screenReview" class="screen">
        <h2>–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ (SRS)</h2>
        <div id="reviewArea" class="card-area"></div>
        <div class="lesson-actions">
          <button id="endReview" class="btn">–ó–∞–∫–æ–Ω—á–∏—Ç—å</button>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <span class="text-muted">MVP by you & GPT ‚Äî –ª–æ–∫–∞–ª—å–Ω–æ, –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–æ–≤.</span>
  </footer>

  <script>
// MonLearn MVP: localStorage state + simple SRS + two lesson types
(function(){
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  // --- Content (A1: Module 0 + 1, small subset) ---
  const course = {
    id: "mon-a1",
    title: "–ú–æ–Ω–≥–æ–ª—å—Å–∫–∏–π A1 (—Ö–∞–ª—Ö–∞, –∫–∏—Ä–∏–ª–ª–∏—Ü–∞)",
    units: [
      {
        id: "u0",
        title: "–ú–æ–¥—É–ª—å 0. –ê–ª—Ñ–∞–≤–∏—Ç –∏ –∑–≤—É–∫",
        lessons: [
          {
            id: "u0l1",
            title: "–ê–ª—Ñ–∞–≤–∏—Ç: –≥–ª–∞—Å–Ω—ã–µ –∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è-–∑–≤—É–∫–∏",
            cards: [
              {
                type: "choice",
                prompt: "–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥: ¬´–°–∞–π–Ω –±–∞–π–Ω–∞ —É—É?¬ª",
                choices: ["–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ?", "–°–ø–∞—Å–∏–±–æ!", "–ò–∑–≤–∏–Ω–∏—Ç–µ"],
                answer: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ?",
                explain: "–§—Ä–∞–∑–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è/–≤–µ–∂–ª–∏–≤–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è."
              },
              {
                type: "build",
                prompt: "–°–æ–±–µ—Ä–∏—Ç–µ: ¬´–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ?¬ª",
                tokens: ["–±–∞–π–Ω–∞", "—É—É?", "–°–∞–π–Ω"],
                answer: ["–°–∞–π–Ω", "–±–∞–π–Ω–∞", "—É—É?"],
                explain: "–í–µ–∂–ª–∏–≤–∞—è —Ñ–æ—Ä–º–∞ –≤–æ–ø—Ä–æ—Å–∞ -—É—É/-“Ø?"
              },
              {
                type: "choice",
                prompt: "–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥: ¬´–ë–∞—è—Ä–ª–∞–ª–∞–∞¬ª",
                choices: ["–°–ø–∞—Å–∏–±–æ", "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞", "–ü—Ä–∏–≤–µ—Ç"],
                answer: "–°–ø–∞—Å–∏–±–æ",
                explain: "–ë–∞—è—Ä–ª–∞–ª–∞–∞ = —Å–ø–∞—Å–∏–±–æ."
              }
            ]
          }
        ]
      },
      {
        id: "u1",
        title: "–ú–æ–¥—É–ª—å 1. –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –±–∞–∑–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã",
        lessons: [
          {
            id: "u1l1",
            title: "–ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ",
            cards: [
              {
                type: "choice",
                prompt: "¬´–ù–∞–º–∞–π–≥ ‚Ä¶ –≥—ç–¥—ç–≥¬ª ‚Äî —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç?",
                choices: ["–ú–µ–Ω—è –∑–æ–≤—É—Ç ‚Ä¶", "–Ø –∏–∑ ‚Ä¶", "–Ø —Ö–æ—á—É ‚Ä¶"],
                answer: "–ú–µ–Ω—è –∑–æ–≤—É—Ç ‚Ä¶",
                explain: "–ù–∞–º–∞–π–≥ ‚Ä¶ –≥—ç–¥—ç–≥ ‚Äî –º–µ–Ω—è –∑–æ–≤—É—Ç ‚Ä¶"
              },
              {
                type: "build",
                prompt: "–°–æ–±–µ—Ä–∏—Ç–µ: ¬´–ú–µ–Ω—è –∑–æ–≤—É—Ç –°–∞—Ä–∞.¬ª",
                tokens: ["–≥—ç–¥—ç–≥.", "–°–∞—Ä–∞–≥", "–ù–∞–º–∞–π–≥"],
                answer: ["–ù–∞–º–∞–π–≥", "–°–∞—Ä–∞–≥", "–≥—ç–¥—ç–≥."],
                explain: "–ò–º—è –ø–æ–ª—É—á–∞–µ—Ç –æ–±—ä–µ–∫—Ç–Ω—ã–π -–≥: –°–∞—Ä–∞–≥."
              },
              {
                type: "choice",
                prompt: "¬´–£—É—á–ª–∞–∞—Ä–∞–π¬ª ‚Äî —ç—Ç–æ‚Ä¶",
                choices: ["–∏–∑–≤–∏–Ω–∏—Ç–µ", "–ø–æ–∂–∞–ª—É–π—Å—Ç–∞ (–¥–∞–π—Ç–µ)", "–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è"],
                answer: "–∏–∑–≤–∏–Ω–∏—Ç–µ",
                explain: "–£—É—á–ª–∞–∞—Ä–∞–π ‚Äî –∏–∑–≤–∏–Ω–∏—Ç–µ/–ø—Ä–æ—Å—Ç–∏—Ç–µ."
              }
            ]
          },
          {
            id: "u1l2",
            title: "–Ø –æ—Ç–∫—É–¥–∞? –ë–∞–∑–æ–≤—ã–µ —Å–≤—è–∑–∫–∏",
            cards: [
              {
                type: "build",
                prompt: "–°–æ–±–µ—Ä–∏—Ç–µ: ¬´–Ø –∏–∑ –ú–æ–Ω–≥–æ–ª–∏–∏.¬ª",
                tokens: ["—É–ª—Å–∞–∞—Å.", "–ú–æ–Ω–≥–æ–ª", "–∏—Ä—Å—ç–Ω", "–ë–∏"],
                answer: ["–ë–∏", "–ú–æ–Ω–≥–æ–ª", "—É–ª—Å–∞–∞—Å.", "–∏—Ä—Å—ç–Ω"],
                explain: "-–∞–∞—Å = –∏—Å—Ö–æ–¥–Ω—ã–π –ø–∞–¥–µ–∂ ¬´–∏–∑¬ª; –∏—Ä—Å—ç–Ω ‚Äî ¬´–ø—Ä–∏–±—ã–≤—à–∏–π/–∏–∑¬ª.",
              },
              {
                type: "choice",
                prompt: "–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥: ¬´–ë–∏ –º–æ–Ω–≥–æ–ª —Ö“Ø–Ω.¬ª",
                choices: ["–Ø –º–æ–Ω–≥–æ–ª/–∫–∞.", "–Ø –∂–∏–≤—É –≤ –ú–æ–Ω–≥–æ–ª–∏–∏.", "–Ø –≥–æ–≤–æ—Ä—é –ø–æ-–º–æ–Ω–≥–æ–ª—å—Å–∫–∏."],
                answer: "–Ø –º–æ–Ω–≥–æ–ª/–∫–∞.",
                explain: "—Ö“Ø–Ω ‚Äî —á–µ–ª–æ–≤–µ–∫; –≤–º–µ—Å—Ç–µ = ¬´—è ‚Äî –º–æ–Ω–≥–æ–ª(–∫–∞)¬ª."
              }
            ]
          }
        ]
      }
    ]
  };

  // --- State
  const LS_KEY = "monlearn_state_v1";
  const newState = ()=>({
    streak: 0, lastDay: null,
    xp: 0,
    hearts: 3,
    progress: {}, // lessonId -> {idx, done}
    srs: {} // lexemeId -> {easiness, interval, due}
  });

  let state = load() || newState();

  function load(){
    try { return JSON.parse(localStorage.getItem(LS_KEY) || ""); } catch(e){ return null; }
  }
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  // Streak logic
  function updateStreak(){
    const today = new Date();
    const dayStr = today.toISOString().slice(0,10);
    if (state.lastDay !== dayStr){
      const prev = state.lastDay ? new Date(state.lastDay) : null;
      if (prev){
        const diff = Math.round((today - prev)/(1000*60*60*24));
        state.streak = (diff === 1) ? (state.streak + 1) : 1;
      } else state.streak = 1;
      state.lastDay = dayStr;
      save();
    }
    $("#streak").textContent = `üî• ${state.streak}`;
  }

  // Hearts UI
  function renderHearts(n){
    const h = $("#hearts");
    h.innerHTML = "";
    for (let i=0;i<n;i++){
      const el = document.createElement("span");
      el.className = "heart"; h.appendChild(el);
    }
  }

  // Progress helpers
  function getAllLessons(){
    return course.units.flatMap(u=>u.lessons.map(l=>({unit:u, lesson:l})));
  }
  function computeProgressPct(){
    const lessons = getAllLessons();
    const total = lessons.length;
    const done = lessons.filter(({lesson}) => state.progress[lesson.id]?.done).length;
    return Math.round((done/total)*100);
  }

  // Unit list
  function renderUnitList(){
    const ul = $("#unitList");
    ul.innerHTML = "";
    course.units.forEach((u, idx)=>{
      const li = document.createElement("li");
      li.innerHTML = `<strong>${idx+1}. ${u.title}</strong>`;
      u.lessons.forEach((l)=>{
        const b = document.createElement("button");
        const done = !!state.progress[l.id]?.done;
        b.textContent = l.title + (done ? " ‚úÖ" : "");
        b.addEventListener("click", ()=>startLesson(u, l));
        li.appendChild(b);
      });
      ul.appendChild(li);
    });
    $("#progressPct").textContent = computeProgressPct()+"%";
  }

  // Navigation
  function show(id){
    $$(".screen").forEach(s=>s.classList.remove("active"));
    $(id).classList.add("active");
  }

  // Lesson flow
  let current = { unit:null, lesson:null, idx:0, xpGained:0 };

  function startLesson(unit, lesson){
    current.unit = unit; current.lesson = lesson;
    const p = state.progress[lesson.id] || { idx:0, done:false };
    current.idx = p.done ? 0 : p.idx;
    current.xpGained = 0;
    state.hearts = 3; renderHearts(state.hearts);
    $("#lessonTitle").textContent = `${unit.title} ‚Üí ${lesson.title}`;
    show("#screenLesson");
    renderCard();
  }

  function renderCard(){
    const cards = current.lesson.cards;
    if (current.idx >= cards.length){ return completeLesson(); }
    const card = cards[current.idx];
    const area = $("#cardArea");
    area.innerHTML = "";
    const box = document.createElement("div");
    box.className = "card";
    const h = document.createElement("h3");
    h.textContent = `–ó–∞–¥–∞–Ω–∏–µ ${current.idx+1} –∏–∑ ${cards.length}`;
    const p = document.createElement("div");
    p.className = "prompt";
    p.textContent = card.prompt;
    box.appendChild(h); box.appendChild(p);

    if (card.type === "choice"){
      const wrap = document.createElement("div");
      wrap.className = "choices";
      // shuffle choices
      const shuffled = [...card.choices].sort(()=>Math.random()-0.5);
      shuffled.forEach(choice=>{
        const b = document.createElement("button");
        b.className = "choice-btn";
        b.textContent = choice;
        b.addEventListener("click", ()=>{
          const ok = choice === card.answer;
          handleAnswer(ok, card);
        });
        wrap.appendChild(b);
      });
      box.appendChild(wrap);
    } else if (card.type === "build"){
      const out = document.createElement("div");
      out.className = "tokens"; out.setAttribute("aria-label","–°–æ–±—Ä–∞–Ω–Ω–∞—è —Ñ—Ä–∞–∑–∞");
      const pool = document.createElement("div");
      pool.className = "tokens";
      const tokens = [...card.tokens].sort(()=>Math.random()-0.5);
      const chosen = [];
      tokens.forEach((t,i)=>{
        const btn = document.createElement("button");
        btn.className = "token";
        btn.textContent = t;
        btn.addEventListener("click", ()=>{
          chosen.push(t);
          btn.disabled = true;
          renderOut();
        });
        pool.appendChild(btn);
      });
      function renderOut(){
        out.innerHTML = "";
        chosen.forEach(t=>{
          const span = document.createElement("span");
          span.className = "token"; span.textContent = t;
          out.appendChild(span);
        });
        if (chosen.length === card.answer.length){
          const ok = chosen.join("|") === card.answer.join("|");
          handleAnswer(ok, card);
        }
      }
      box.appendChild(out);
      box.appendChild(pool);
    }

    area.appendChild(box);
    $("#skipCard").onclick = ()=>{ current.idx++; renderCard(); };
  }

  function handleAnswer(ok, card){
    const area = $("#cardArea");
    const res = document.createElement("div");
    res.className = "result" + (ok ? "" : " bad");
    res.textContent = ok ? "–í–µ—Ä–Ω–æ! +5 XP" : ("–ù–µ–≤–µ—Ä–Ω–æ. " + (card.explain || ""));
    area.appendChild(res);
    if (ok){ current.xpGained += 5; }
    else {
      state.hearts -= 1; renderHearts(state.hearts);
      if (state.hearts <= 0){
        const r = document.createElement("div");
        r.className = "result bad";
        r.textContent = "–ñ–∏–∑–Ω–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.";
        area.appendChild(r);
        setTimeout(()=>startLesson(current.unit, current.lesson), 900);
        save();
        return;
      }
    }
    // small pause then next
    setTimeout(()=>{
      current.idx++;
      saveProgress();
      renderCard();
    }, 650);
  }

  function saveProgress(){
    const id = current.lesson.id;
    const cards = current.lesson.cards;
    const done = current.idx >= cards.length;
    state.progress[id] = { idx: Math.min(current.idx, cards.length-1), done };
    save();
  }

  function completeLesson(){
    state.xp = (state.xp || 0) + current.xpGained;
    state.progress[current.lesson.id] = { idx: 0, done: true };
    $("#xpGained").textContent = String(current.xpGained);
    save();
    renderUnitList();
    show("#screenComplete");
  }

  // Review (SRS) ‚Äî simplified per-phrase queue using SM-2-like steps
  const reviewPool = [
    { id:"saingreet", q:"–°–∞–π–Ω –±–∞–π–Ω–∞ —É—É? ‚Üí RU", a:"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ?" },
    { id:"bayarlalaa", q:"–ë–∞—è—Ä–ª–∞–ª–∞–∞ ‚Üí RU", a:"–°–ø–∞—Å–∏–±–æ" },
    { id:"namaig", q:"–ù–∞–º–∞–π–≥ ‚Ä¶ –≥—ç–¥—ç–≥ ‚Üí RU", a:"–ú–µ–Ω—è –∑–æ–≤—É—Ç ‚Ä¶" },
    { id:"uchlaarai", q:"–£—É—á–ª–∞–∞—Ä–∞–π ‚Üí RU", a:"–ò–∑–≤–∏–Ω–∏—Ç–µ" },
    { id:"bi-mongol", q:"–ë–∏ –º–æ–Ω–≥–æ–ª —Ö“Ø–Ω. ‚Üí RU", a:"–Ø –º–æ–Ω–≥–æ–ª/–∫–∞." }
  ];

  function getCardState(id){
    if (!state.srs[id]) state.srs[id] = { easiness:2.5, interval:0, due:Date.now() };
    return state.srs[id];
  }
  function schedule(id, quality){ // quality 0..5
    const s = getCardState(id);
    const now = Date.now();
    if (quality < 3){
      s.interval = 1;
    } else {
      if (s.interval === 0){ s.interval = 1; }
      else if (s.interval === 1){ s.interval = 6; }
      else { s.interval = Math.round(s.interval * s.easiness); }
      s.easiness = Math.max(1.3, s.easiness + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02)));
    }
    s.due = now + s.interval * 24*60*60*1000;
    save();
  }

  function startReview(){
    show("#screenReview");
    renderReview();
  }

  function renderReview(){
    const area = $("#reviewArea");
    area.innerHTML = "";
    const now = Date.now();
    const dueCards = reviewPool.filter(c => getCardState(c.id).due <= now);
    if (dueCards.length === 0){
      const d = document.createElement("div"); d.className = "result";
      d.textContent = "–ü–æ–∫–∞ –Ω–µ—á–µ–≥–æ –ø–æ–≤—Ç–æ—Ä—è—Ç—å. –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –ø–æ–∑–∂–µ!";
      area.appendChild(d); return;
    }
    const card = dueCards[Math.floor(Math.random()*dueCards.length)];
    const box = document.createElement("div"); box.className = "card";
    box.innerHTML = `<h3>–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</h3><div class="prompt">${card.q}</div>`;
    const input = document.createElement("input");
    input.type = "text"; input.placeholder = "–í–∞—à –æ—Ç–≤–µ—Ç‚Ä¶";
    input.className = "choice-btn"; input.style.width = "100%";
    const row = document.createElement("div"); row.className = "cta-row";
    const showBtn = document.createElement("button"); showBtn.className = "btn"; showBtn.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç";
    const okBtn = document.createElement("button"); okBtn.className = "btn primary"; okBtn.textContent = "–í–µ—Ä–Ω–æ";
    const hardBtn = document.createElement("button"); hardBtn.className = "btn subtle"; hardBtn.textContent = "–° —Ç—Ä—É–¥–æ–º";
    const badBtn = document.createElement("button"); badBtn.className = "btn subtle"; badBtn.textContent = "–û—à–∏–±–∫–∞";

    showBtn.onclick = ()=>{
      const r = document.createElement("div"); r.className = "result";
      r.textContent = `–û—Ç–≤–µ—Ç: ${card.a}`; box.appendChild(r);
    };
    okBtn.onclick = ()=>{ schedule(card.id,5); renderReview(); };
    hardBtn.onclick = ()=>{ schedule(card.id,3); renderReview(); };
    badBtn.onclick = ()=>{ schedule(card.id,1); renderReview(); };

    box.appendChild(input);
    row.appendChild(showBtn); row.appendChild(okBtn); row.appendChild(hardBtn); row.appendChild(badBtn);
    box.appendChild(row);
    area.appendChild(box);
  }

  // Buttons & init
  $("#startLesson").onclick = ()=>{
    const first = getAllLessons().find(({lesson}) => !state.progress[lesson.id]?.done) || getAllLessons()[0];
    startLesson(first.unit, first.lesson);
  };
  $("#reviewBtn").onclick = startReview;
  $("#backHome").onclick = ()=>show("#screenHome");
  $("#toReview").onclick = startReview;
  $("#endReview").onclick = ()=>show("#screenHome");
  $("#resetProgress").onclick = ()=>{
    if (confirm("–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?")){
      state = newState(); save(); renderUnitList(); updateStreak(); show("#screenHome");
    }
  };

  renderUnitList();
  updateStreak();
  show("#screenHome");
})();
</script>
</body>
</html>
